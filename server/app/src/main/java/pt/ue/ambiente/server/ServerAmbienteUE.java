/*
 * This source file was generated by the Gradle 'init' task
 */
package pt.ue.ambiente.server;

import java.io.IOException;
import java.util.ArrayList;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.CommandLineRunner;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.data.jpa.repository.config.EnableJpaRepositories;

import io.grpc.Server;
import io.grpc.ServerBuilder;
import pt.ue.ambiente.server.data.ServerAmbienteDataUE;
import pt.ue.ambiente.server.data.entity.Departamento;
import pt.ue.ambiente.server.data.entity.Dispositivo;
import pt.ue.ambiente.server.data.entity.Edificio;
import pt.ue.ambiente.server.data.entity.Piso;
import pt.ue.ambiente.server.data.entity.Sala;
import pt.ue.ambiente.server.data.enumeration.Protocolo;
import pt.ue.ambiente.server.grpc.ServerAmbienteGrpcUE;
import pt.ue.ambiente.server.mqtt.ServerAmbienteMqttUE;
import pt.ue.ambiente.server.rest.ServerAmbienteRestMetricasUE;

@SpringBootApplication
@EnableJpaRepositories(basePackages = "pt.ue.ambiente.server.data.repository")
public class ServerAmbienteUE implements CommandLineRunner {
    private static final Logger logger = LoggerFactory.getLogger(ServerAmbienteUE.class);

    private Server grpcServer;

    @Autowired
    private ServerAmbienteGrpcUE grpcServerAmbienteUE;

    @Autowired
    private ServerAmbienteMqttUE mqttServerAmbienteUE;

    @Autowired
    private ServerAmbienteRestMetricasUE restMetricasServerAmbienteUE;

    @Autowired
    private ServerAmbienteDataUE repositories;

    public static void main(String[] args) {
        SpringApplication.run(ServerAmbienteUE.class, args);
    }

    @Override
    public void run(String... args) {

        try {
            mqttServerAmbienteUE.init();
            this.startGrpcServer();
            this.blockUntilShutdown();
        } catch (IOException | InterruptedException e) {
            e.printStackTrace();
        }
    }

    public void startGrpcServer() throws IOException {
        grpcServer = ServerBuilder.forPort(50051).addService(grpcServerAmbienteUE).build().start();

        logger.info("===========================================");
        logger.info("Servidor gRPC iniciado na porta 50051");
        logger.info("===========================================");

        Runtime.getRuntime()
                .addShutdownHook(
                        new Thread(
                                () -> {
                                    logger.info(
                                            "*** Shutting down gRPC server since JVM is shutting down");
                                    if (grpcServer != null) {
                                        grpcServer.shutdown();
                                    }
                                    logger.info("*** Server shut down");
                                }));
    }

    private void blockUntilShutdown() throws InterruptedException {
        if (grpcServer != null) {
            grpcServer.awaitTermination();
        }
    }
}
